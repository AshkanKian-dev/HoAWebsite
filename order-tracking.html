<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View your transaction history - Heart of Acheron">
    <title>Transaction History - Heart of Acheron</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // Set API base URL (update this to match your backend URL)
        window.API_BASE_URL = window.API_BASE_URL || 'http://localhost:3000';
    </script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="nav-container">
                <div class="logo">
                    <img src="images/logo/logo.png" alt="Heart of Acheron Logo" onerror="this.style.display='none'">
                    <h1>Heart of Acheron</h1>
                </div>
                <ul class="nav-menu">
                    <li><a href="index.html" class="nav-link">Home</a></li>
                    <li><a href="forum.html" class="nav-link">Forum</a></li>
                    <li><a href="server-info.html" class="nav-link">Server Information</a></li>
                    <li><a href="shop.html" class="nav-link">Shop</a></li>
                    <li><a href="contact.html" class="nav-link">Contact</a></li>
                </ul>
                <div class="user-icon-container">
                    <button class="user-icon-btn" id="userIconBtn" aria-label="User menu">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20.59 22C20.59 18.13 16.74 15 12 15C7.26 15 3.41 18.13 3.41 22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="user-dropdown-header" id="userDropdownHeader">Account</div>
                        <a href="login.html" class="user-dropdown-item" id="loginLink">Log In</a>
                        <a href="register.html" class="user-dropdown-item" id="registerLink">Create Account</a>
                        <div id="loggedInMenu" style="display: none;">
                            <a href="profile.html" class="user-dropdown-item" id="profileLink">Profile</a>
                            <a href="order-tracking.html" class="user-dropdown-item" id="ordersLink">Transaction History</a>
                            <a href="#" class="user-dropdown-item" id="helpLink">Help</a>
                            <a href="#" class="user-dropdown-item" id="resetPasswordLink">Reset Password</a>
                            <a href="#" class="user-dropdown-item logout" id="logoutLink">Logout</a>
                        </div>
                    </div>
                </div>
                <button class="mobile-menu-toggle" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
    </header>

    <main>
        <section class="section">
            <div class="container">
                <h2 class="section-title">Transaction History</h2>
                
                <div style="max-width: 900px; margin: 0 auto;">
                    <div id="loadingMessage" class="server-info-card" style="text-align: center; padding: 3rem;">
                        <p style="opacity: 0.9;">Loading your transaction history...</p>
                    </div>

                    <div id="transactionHistory" style="display: none;">
                        <!-- Transaction history will be displayed here -->
                    </div>

                    <div id="errorMessage" class="payment-error" style="display: none; margin-top: 1rem; text-align: center;"></div>

                    <div id="noTransactions" class="server-info-card" style="display: none; text-align: center; padding: 3rem;">
                        <h3 style="color: var(--secondary-color); margin-bottom: 1rem;">No Transactions Yet</h3>
                        <p style="opacity: 0.9; margin-bottom: 2rem;">You haven't made any purchases yet. Visit our shop to get started!</p>
                        <a href="shop.html" class="btn btn-primary">Visit Shop</a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 Heart of Acheron. All rights reserved. | <a href="about.html" style="color: var(--secondary-color); text-decoration: none;">About & FAQs</a></p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script>
        // Use API_BASE_URL from auth.js
        const API_BASE = window.API_BASE_URL || 'http://localhost:3000';

        // Load transaction history when page loads
        window.addEventListener('load', async function() {
            await loadTransactionHistory();
        });

        async function loadTransactionHistory() {
            const loadingDiv = document.getElementById('loadingMessage');
            const historyDiv = document.getElementById('transactionHistory');
            const errorDiv = document.getElementById('errorMessage');
            const noTransactionsDiv = document.getElementById('noTransactions');

            // Hide all initially
            loadingDiv.style.display = 'block';
            historyDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            noTransactionsDiv.style.display = 'none';

            try {

                // Check if user is logged in
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    // Redirect to login if not authenticated
                    window.location.href = 'login.html?return=order-tracking.html';
                    return;
                }

                let transactions = [];
                let userEmail = null;

                // Try to get user info (check if using mock auth)
                try {
                    // Try backend first
                    const userResponse = await fetch(`${API_BASE}/api/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });

                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        userEmail = userData.user.email;

                        // Fetch transactions from backend
                        const transactionsResponse = await fetch(`${API_BASE}/api/orders/email/${encodeURIComponent(userEmail)}`, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });

                        if (transactionsResponse.ok) {
                            const transactionsData = await transactionsResponse.json();
                            transactions = transactionsData.orders || [];
                        }
                    } else {
                        throw new Error('Backend unavailable');
                    }
                } catch (backendError) {
                    // Backend not available, use mock data
                    console.log('Backend unavailable, using mock transaction data');
                    
                    // Get user from mock session
                    const mockSession = JSON.parse(localStorage.getItem('mockSession') || 'null');
                    if (mockSession && mockSession.token === authToken) {
                        userEmail = mockSession.email;
                        
                        // Get mock transactions from localStorage
                        const mockTransactions = JSON.parse(localStorage.getItem('mockTransactions') || '[]');
                        transactions = mockTransactions.filter(t => t.email === userEmail);
                    } else {
                        // Try to get user from currentUser if available
                        if (window.getCurrentUser) {
                            const currentUser = window.getCurrentUser();
                            if (currentUser) {
                                userEmail = currentUser.email;
                                const mockTransactions = JSON.parse(localStorage.getItem('mockTransactions') || '[]');
                                transactions = mockTransactions.filter(t => t.email === userEmail);
                            }
                        }
                    }
                }

                loadingDiv.style.display = 'none';

                if (transactions.length === 0) {
                    noTransactionsDiv.style.display = 'block';
                } else {
                    displayTransactionHistory(transactions);
                    historyDiv.style.display = 'block';
                }

            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = error.message || 'An error occurred while loading your transaction history';
                errorDiv.style.display = 'block';
                
                // If not authenticated, redirect to login
                if (error.message === 'Not authenticated' || error.message.includes('401')) {
                    setTimeout(() => {
                        window.location.href = 'login.html?return=order-tracking.html';
                    }, 2000);
                }
            }
        }

        function displayTransactionHistory(transactions) {
            const historyDiv = document.getElementById('transactionHistory');
            
            // Sort transactions by date (most recent first)
            transactions.sort((a, b) => {
                const dateA = new Date(a.created_at || 0);
                const dateB = new Date(b.created_at || 0);
                return dateB - dateA;
            });

            historyDiv.innerHTML = `
                <div class="server-info-card">
                    <h3 style="color: var(--secondary-color); margin-bottom: 1.5rem; text-align: center;">Your Transactions (${transactions.length})</h3>
                    <div style="display: grid; gap: 1rem;">
                        ${transactions.map(transaction => {
                            const transactionDate = transaction.created_at 
                                ? new Date(transaction.created_at).toLocaleString() 
                                : 'Unknown';
                            
                            const transactionId = transaction.order_id || transaction.payment_intent_id || 'N/A';
                            const amount = transaction.price || transaction.amount || 0;
                            const productName = transaction.product_name || 'Unknown Product';
                            
                            return `
                                <div style="padding: 1.5rem; background: rgba(0, 0, 0, 0.3); border-radius: 8px; border: 2px solid var(--border-glow); transition: all 0.3s ease;">
                                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: start;">
                                        <div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; align-items: center;">
                                                <h4 style="color: var(--secondary-color); margin: 0; font-size: 1.1rem;">${productName}</h4>
                                                <span style="color: var(--accent); font-weight: bold; font-size: 1.2rem;">$${parseFloat(amount).toFixed(2)}</span>
                                            </div>
                                            <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 0.5rem;">
                                                <strong>Transaction ID:</strong> <span style="font-family: monospace; color: var(--text-light);">${transactionId}</span>
                                            </div>
                                            <div style="font-size: 0.9rem; opacity: 0.8;">
                                                <strong>Date:</strong> ${transactionDate}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>

