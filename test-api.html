<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Connection Test - Heart of Acheron</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 2px solid #d4af37;
        }
        .success {
            color: #00ff00;
        }
        .error {
            color: #ff0000;
        }
        .info {
            color: #d4af37;
        }
        button {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background: #f5d876;
        }
        pre {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.pending {
            background: #333;
            color: #d4af37;
        }
        .status.success {
            background: #003300;
            color: #00ff00;
        }
        .status.error {
            background: #330000;
            color: #ff0000;
        }
    </style>
</head>
<body>
    <h1>üîß API Connection Diagnostic Tool</h1>
    
    <div class="test-section">
        <h2>1. Backend Server Status</h2>
        <button onclick="testBackendConnection()">Test Backend Connection</button>
        <div id="backendStatus" class="status pending">Click button to test...</div>
        <pre id="backendResponse"></pre>
    </div>

    <div class="test-section">
        <h2>2. Server Status API</h2>
        <button onclick="testServerStatus()">Test /api/server/status</button>
        <div id="serverStatus" class="status pending">Click button to test...</div>
        <pre id="serverResponse"></pre>
    </div>

    <div class="test-section">
        <h2>3. Configuration Check</h2>
        <div id="configInfo" class="info">
            <p><strong>API Base URL:</strong> <span id="apiBase">http://localhost:3000</span></p>
            <p><strong>Expected Endpoint:</strong> <span id="endpoint">http://localhost:3000/api/server/status</span></p>
        </div>
    </div>

    <div class="test-section">
        <h2>4. Troubleshooting Steps</h2>
        <ol>
            <li>Make sure backend server is running: <code>cd backend && npm start</code></li>
            <li>Check that .env file has AMP_API_URL set: <code>AMP_API_URL=https://amp.roejin.com/API/</code></li>
            <li>Verify backend is listening on port 3000</li>
            <li>Check browser console (F12) for CORS or network errors</li>
        </ol>
    </div>

    <script>
        const API_BASE = window.API_BASE_URL || 'http://localhost:3000';

        async function testBackendConnection() {
            const statusDiv = document.getElementById('backendStatus');
            const responseDiv = document.getElementById('backendResponse');
            
            statusDiv.className = 'status pending';
            statusDiv.textContent = 'Testing connection...';
            responseDiv.textContent = '';

            try {
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Backend server is running!';
                    responseDiv.textContent = JSON.stringify(data, null, 2);
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = `‚ùå Backend responded with error: ${response.status}`;
                    responseDiv.textContent = `Status: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Cannot connect to backend server';
                responseDiv.textContent = `Error: ${error.message}\n\nPossible causes:\n- Backend server is not running\n- Wrong port number\n- Firewall blocking connection\n- CORS issue`;
            }
        }

        async function testServerStatus() {
            const statusDiv = document.getElementById('serverStatus');
            const responseDiv = document.getElementById('serverResponse');
            
            statusDiv.className = 'status pending';
            statusDiv.textContent = 'Testing server status API...';
            responseDiv.textContent = '';

            try {
                const response = await fetch(`${API_BASE}/api/server/status`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '‚úÖ Server status API is working!';
                    responseDiv.textContent = JSON.stringify(data, null, 2);
                    
                    // Show key information
                    if (data.server) {
                        const info = document.createElement('div');
                        info.style.marginTop = '10px';
                        info.innerHTML = `
                            <strong>Server Status:</strong> ${data.server.status}<br>
                            <strong>Player Count:</strong> ${data.server.playerCount} / ${data.server.maxPlayers}<br>
                            <strong>IP:</strong> ${data.server.ip}<br>
                            <strong>Connect String:</strong> ${data.server.connectString}
                        `;
                        responseDiv.parentElement.appendChild(info);
                    }
                } else {
                    const errorText = await response.text();
                    statusDiv.className = 'status error';
                    statusDiv.textContent = `‚ùå API responded with error: ${response.status}`;
                    responseDiv.textContent = `Status: ${response.status} ${response.statusText}\n\nResponse: ${errorText}`;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Cannot connect to server status API';
                responseDiv.textContent = `Error: ${error.message}\n\nPossible causes:\n- Backend server is not running\n- API endpoint not found\n- CORS issue\n- Network error`;
            }
        }

        // Update display
        document.getElementById('apiBase').textContent = API_BASE;
        document.getElementById('endpoint').textContent = `${API_BASE}/api/server/status`;
    </script>
</body>
</html>
